<!DOCTYPE html>

<html lang="en">
<head>
    <title>5.19 - SSL/TLS Filter &mdash; Apache MINA</title>

    <link href="/assets/css/common.css" rel="stylesheet" type="text/css"/>
    <link href="/assets/css/mina.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<script src="https://www.apachecon.com/event-images/snippet.js"></script>
<div id="container">
    <div id="header">
    <div id="subProjectsNavBar">
        <a href="/">
            
                Apache MINA Project
            
        </a>
        &nbsp;|&nbsp;
        <a href="/mina-project/">
            
                <strong>MINA</strong>
            
        </a>
        &nbsp;|&nbsp;
        <a href="/asyncweb-project/">
            
                AsyncWeb
            
        </a>
        &nbsp;|&nbsp;
        <a href="/ftpserver-project/">
            
                FtpServer
            
        </a>
        &nbsp;|&nbsp;
        <a href="/sshd-project/">
            
                SSHD
            
        </a>
        &nbsp;|&nbsp;
        <a href="/vysper-project/">
            
                Vysper
            
        </a>
    </div>
</div>


    <div id="content">
        <div id="leftColumn">
            <div id="navigation">
                <a class="acevent" data-format="wide" data-width="170"></a>
                <h5>Social Networks</h5>
                <ul>
                    <li><a href="https://fosstodon.org/@apachemina">Apache MINA Mastodon</a></li>
                </ul>
                <h5>Latest Downloads</h5>
                <ul>
                    <li><a href="/mina-project/downloads_2_0.html">Mina 2.0.25</a></li>
                    <li><a href="/mina-project/downloads_2_1.html">Mina 2.1.8</a></li>
                    <li><a href="/mina-project/downloads_2_2.html">Mina 2.2.3</a></li>
                    <li><a href="/mina-project/downloads_old.html">Mina old versions</a></li>
                </ul>
                <h5>Documentation</h5>
                <ul>
                    <li><a href="/mina-project/documentation.html" class="external-link" rel="nofollow">Base documentation</a></li>
                    <li><a href="/mina-project/userguide/user-guide-toc.html" class="external-link" rel="nofollow">User guide</a></li>
                    <li><a href="/mina-project/2.2-vs-2.1.html" class="external-link" rel="nofollow">2.2 vs 2.1</a></li>
                    <li><a href="/mina-project/2.1-vs-2.0.html" class="external-link" rel="nofollow">2.1 vs 2.0</a></li>
                    <li><a href="/mina-project/features.html" class="external-link" rel="nofollow">Features</a></li>
                    <li><a href="/mina-project/road-map.html" class="external-link" rel="nofollow">Road Map</a></li>
                    <li><a href="/mina-project/quick-start-guide.html" class="external-link" rel="nofollow">Quick Start Guide</a></li>
                    <li><a href="/mina-project/faq.html" class="external-link" rel="nofollow">FAQ</a></li>
                </ul>
                <h5>Resources</h5>
                <ul>
                    <li><a href="/mina-project/mailing-lists.html" class="external-link" rel="nofollow">Mailing lists &amp; IRC</a></li>
                    <li><a href="/mina-project/issue-tracking.html" class="external-link" rel="nofollow">Issue tracking</a></li>
                    <li><a href="/mina-project/sources.html" class="external-link" rel="nofollow">Sources</a></li>
                    <li><a href="/mina-project/gen-docs/latest-2.0/apidocs/index.html" class="external-link" rel="nofollow">API Javadoc 2.0.25</a></li>
                    <li><a href="/mina-project/gen-docs/latest-2.1/apidocs/index.html" class="external-link" rel="nofollow">API Javadoc 2.1.8</a></li>
                    <li><a href="/mina-project/gen-docs/latest-2.2/apidocs/index.html" class="external-link" rel="nofollow">API Javadoc 2.2.3</a></li>
                    <li><a href="/mina-project/gen-docs/latest-2.0/xref/index.html" class="external-link" rel="nofollow">API xref  2.0.25</a></li>
                    <li><a href="/mina-project/gen-docs/latest-2.1/xref/index.html" class="external-link" rel="nofollow">API xref 2.1.8</a></li>
                    <li><a href="/mina-project/gen-docs/latest-2.2/xref/index.html" class="external-link" rel="nofollow">API xref 2.2.3</a></li>
                    <li><a href="/mina-project/performances.html" class="external-link" rel="nofollow">Performances</a></li>
                    <li><a href="/mina-project/testimonials.html" class="external-link" rel="nofollow">Testimonials</a></li>
                    <li><a href="/mina-project/conferences.html" class="external-link" rel="nofollow">Conferences</a></li>
                    <li><a href="/mina-project/developer-guide.html" class="external-link" rel="nofollow">Developers Guide</a></li>
                    <li><a href="/mina-project/related-projects.html" class="external-link" rel="nofollow">Related Projects</a></li>
                    <li><a href="https://people.apache.org/~vgritsenko/stats/projects/mina.html" class="external-link" rel="nofollow">Statistics</a></li>
                </ul>

                <h5>Community</h5>
                <ul>
                    <li><a href="https://www.apache.org/foundation/contributing.html" class="external-link" rel="nofollow">Contributing</a></li>
                    <li><a href="/contributors.html" class="external-link" rel="nofollow">Team</a></li>
                    <li><a href="/special-thanks.html" class="external-link" rel="nofollow">Special Thanks</a></li>
                    <li><a href="https://www.apache.org/security/" class="external-link" rel="nofollow">Security</a></li>
                </ul>

                <h5>About Apache</h5>
                <ul>
                    <li><a href="https://www.apache.org" class="external-link" rel="nofollow">Apache main site</a></li>
                    <li><a href="https://www.apache.org/licenses/" class="external-link" rel="nofollow">License</a></li>
                    <li><a href="https://www.apache.org/foundation/sponsorship.html" title="The ASF sponsorship program" class="external-link" rel="nofollow">Sponsorship program</a></li>
                    <li><a href="https://www.apache.org/foundation/thanks.html" class="external-link" rel="nofollow">Thanks</a></li>
                </ul>

                <h3><a name="Navigation-Upcoming"></a>Upcoming</h3>
                <ul>
                    <li>No event</li>
                </ul>
            </div>
        </div>
        <div id="rightColumn">
            
    <div class="nav">
        <div class="nav_prev">
            
                
                <a href="ch5.18-stream-write-filter.html">5.18 - Stream Write Filter</a>
            
        </div>
        <div class="nav_up">
            
                
                <a href="ch5-filters.html">Chapter 5 - Filters</a>
            
        </div>
        <div class="nav_next">
            
                
                <a href="ch5.20-write-request-filter.html">5.20 - Write Request Filter</a>
            
        </div>
        <div class="clearfix"></div>
    </div>


            
	<h1 id="519---ssltls-filter">5.19 - SSL/TLS Filter</h1>
<p>This is a critical part of any serious network application: securing the communication between the client and the server.</p>
<p>In <strong>MINA</strong>, we do that with the <strong>SslFilter</strong>. The idea is to add this <em>Filter</em> in the chain and it will deal with the <em>Handshake</em> negociation, and the following encrypting and uncrypting of the data.</p>
<h2 id="how-it-works">How it works</h2>
<p>The thing to remember is that the <strong>TLS</strong> protocol works in two steps:</p>
<ul>
<li>First there is a negociation part (the <em>Handshake</em>)</li>
<li>Then once the <em>Handshake</em> is completed, all the data will be encrypted before being sent, and decryptd when received.</li>
</ul>
<p>We just have to add the filter in the chain like this:</p>
<pre><code>   ...
   SslFilter sslFilter = new SslFilter(sslContext);
   DefaultIoFilterChainBuilder chain = acceptor.getFilterChain();
   chain.addFirst(&quot;sslFilter&quot;, sslFilter);
   ...

</code></pre><p>The <em>chain</em> is the instance of <strong>IoFilterChainBuilder</strong> class that is associated with either the <em>Connector</em> or the <em>Acceptor</em> instances (wether we are using a client or a server). It will be used when a connection is set to define the filter chain this connected session will use.</p>
<div class="note" markdown="1">
Usually the **SSLFilter** is always set at the first position in the chain. The rationnal is that it will receive and send encrypted data, so there is little use of having a functionnal filter between the head of the chain and the **SslFilter**. However, if such a filter is to be used, make sure it does not interfere with the data being exchanged with the remote peer.
</div>
<p>The missing part here is the <em>sslContext</em> which has to be defined. It&rsquo;s an instance of the <strong>SSLContext</strong> class, where you define a <strong>TrustManager</strong>, a <strong>KeyManager</strong> and a <strong>Securerandom</strong>.</p>
<div class="note" markdown="1">
	This part is strandard Java security. You'll find plenty of pages on internet explaining you to set up a proper _SSLContext_ instance.
</div>
<p>The filter can be added either <em>before</em> the connection has been established, or <em>after</em> the connection has been established.
In the first case, it&rsquo;s easy, the filter initialisation will be done when the connection is created. The second is a bit more complex, as we will have to deal with ongoing messages.</p>
<h3 id="initialization">Initialization</h3>
<p>When a connection is created, the filter chain is created, and the <strong>SslFilter</strong> is added to this chain, which intializes it. The filter&rsquo;s <em>onPreAdd</em> method is called, which will only check if the filter has already been added (we can&rsquo;t have the <strong>SslFilter</strong> twice in the chain).</p>
<p>The filter&rsquo;s <em>onPostAdd</em> method is then called, and if the <em>autostart</em> flag is set to <em>true</em> and the session is connected (which should be the case&hellip;), then the <em>onConnected</em> method is called.</p>
<div class="note" markdown="1">
   The _autostart_ flag can be set when creating the **SslFilter**. It indicates that the filter will be initialized immediatly on a new connection. Otherwise the filter will be initialized later on when the session will have been opened.
</div>
<p>The <strong>SslHandler</strong> will then be created, which will contain a newly created <strong>SslEngine</strong>. This is the place where the <strong>TLS</strong> parameters will be set:</p>
<ul>
<li>The authentication <strong>WANT</strong> or <strong>NEED</strong> flags</li>
<li>The cipher suite</li>
<li>The enabled protocols</li>
<li>The endpoint identification algorithms</li>
<li>and finally the flag indicating if it&rsquo;s for a server or a client</li>
</ul>
<p>All those flags are optionnal but the last one.</p>
<p>The newly created <strong>SslHandler</strong> instance will be added into the session&rsquo;s attributes, under the <em>org.apache.mina.filter.ssl.SslHandler.handler@<ID></em> key (The <strong>ID</strong> part is unique).</p>
<p>Last, not least, the <strong>SslHandler</strong> instance is opened. If we are on the client side, the <strong>TLS</strong> <em>Handshake</em> will be started, otherwise a flag will be set to indicate we are expecting a <em>Handshake</em> on the server side.</p>
<p>We are all set and ready for the <em>Handshake</em> to be processed!</p>
<h3 id="handshake">Handshake</h3>
<p>The <em>Handshake</em> must be done as soon as the <strong>TLS</strong> layer is activated. It&rsquo;s initiated by the client, which must send a <em>CLIENT_HELLO</em> message (see the <a href="https://tls13.xargs.org/#client-hello">Client Hello</a> description), but the server must be ready to accept this message.</p>
<p>We will consider two use cases: the <strong>Client</strong> side and the <strong>Server</strong> side (as <strong>Mina</strong> can handle both sides, but could work with a peer written using a different implementation)</p>
<h4 id="initial-handshake-message">Initial Handshake message</h4>
<p>The first <em>Handshake</em> message to be processed is the <strong>CLIENT HELLO</strong> <strong>TLS</strong> message.</p>
<h5 id="server-side">Server side</h5>
<p>The <em>Handshake</em> is initiated by a <strong>CLIENT_HELLO</strong> <strong>TLS</strong> request which is sent by the client, the server is waiting for it. There starts a serie of <strong>TLS</strong> messages exchanged between the cleint and the server, at the end of which the session is secured, and data can be exchanged encrypted.</p>
<p>What is important to note here is that during the <em>Handshake</em> exchanges, no application data can be sent, and the <strong>SslFilter</strong> is handling the whole process, before returning the hand to the application. That means messages emitted by the application will be stacked until the session is secured.</p>
<h5 id="client-side">Client side</h5>
<p>The client is the initiator of the <em>Handshake</em> exchange. The difference with  the server is that the client <strong>SSLhandler</strong> will generate the inital <em>Handshake</em> message (<strong>CLIENT HELLO</strong>) and send it to the server</p>
<h4 id="follow-up-handshake-messages">Follow up Handshake messages</h4>
<p>Once the <em>Handshake</em> has been initiated, the dance keeps going until the <em>Handshake</em> is either done or fails:</p>
<ul>
<li>The client sends <em>Handshake</em> requests</li>
<li>The server sends <em>Handshake</em> responses</li>
</ul>
<p>This dance can use many steps.</p>
<p>It ends with both side send a <em>finished</em> message, and has verified that it&rsquo;s valid.</p>
<h3 id="session-secured">Session secured</h3>
<p>The application is informed that the session is secured:</p>
<ul>
<li>In <strong>MINA</strong> 2.0.X, the <strong>SslFilterMessage</strong> message is sent and can be processed in the <strong>IoHandler.messageReived</strong> handler.</li>
<li>In <strong>MINA</strong> 2.1.X and 2.2.X, the <strong>IoHandler</strong> interface exposes an <em>event</em> handler that is used by the <strong>SslFilter</strong> to inform the application that the session is secured, by emmiting a <strong>SslEvent.SECURED</strong> event.</li>
</ul>
<p>It&rsquo;s clear that the way <strong>MINA</strong> 2.1.X and 2.2.X signal that the session is secured is way simpler.</p>
<h3 id="starttls-use-case">StartTLS use case</h3>
<p>Some protocols, like <strong>LDAP</strong>, <strong>FTP</strong>, <strong>XMPP</strong>, <strong>NNTP</strong>, <strong>SMTP</strong>, can be used without encryption, but allow some encryption to be set by using a specific command. When this command is issued, the <strong>TLS</strong> layer is added to an already connected session, without reestablishing a new session.</p>
<p>That is what the <strong>startTLS</strong> command is used for that purpose. Here are a list of existing protocols that use this mechanism:</p>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc2595"><strong>IMAP, POP3 and ACAP</strong></a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc3207"><strong>SMTP</strong></a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc6120"><strong>XMPP</strong></a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc4642"><strong>NNTP</strong></a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc4513"><strong>LDAP</strong></a></li>
</ul>
<p>The way it works is that at some point of a clear text established connection, the client sends a <strong>STARTLS</strong> command, which forces the <strong>TLS</strong> <em>Handshake</em> to start to establish a secured connection. When the secured connection is established, the client and the server exchanges will be encrypted.</p>
<p>Now, that is a bit tricky to implement, because both the client <em>and</em> the server must block the exchange of messages during the establishement of the <strong>TLS</strong> session. As the client is the initiator of the command, it&rsquo;s easy, but on the server side, we must pass a response to the original command <strong>in clear text</strong> informing the client that the command has been received and processed.</p>
<pre><code>(C) The client sends a **StartTLS** command
(S) The server receives the command, initialize the **TLS** layer, and send back a response to the client, bypassing the **TLS** layer.
(C) The client received the server response to the command, and setup the **TLS** layer, and initiates the **TLS** _Handshake_
(S/C) The _Handshake_ is processed
(S/C) The session is secured on both side
(S/C) at this point, every message exchanged are encrypted.
</code></pre>

            
    <div class="nav">
        <div class="nav_prev">
            
                
                <a href="ch5.18-stream-write-filter.html">5.18 - Stream Write Filter</a>
            
        </div>
        <div class="nav_up">
            
                
                <a href="ch5-filters.html">Chapter 5 - Filters</a>
            
        </div>
        <div class="nav_next">
            
                
                <a href="ch5.20-write-request-filter.html">5.20 - Write Request Filter</a>
            
        </div>
        <div class="clearfix"></div>
    </div>


        </div>
        <div id="endContent"></div>
    </div>

    <div id="footer">
    &copy; 2003-2024, <a href="https://www.apache.org">The Apache Software Foundation</a> - <a href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy Policy</a><br />
    Apache MINA, MINA, Apache Vysper, Vysper, Apache SSHd, SSHd, Apache FtpServer, FtpServer, Apache AsyncWeb, AsyncWeb,
    Apache, the Apache feather logo, and the Apache Mina project logos are trademarks of The Apache Software Foundation.
</div>

</div>

</body>

</html>
